const LineAdapter = require('../adapters/line-adapter');
const VideoService = require('../core/video-service');
const UserService = require('../core/user-service');
const MessageTemplates = require('../utils/message-templates');
const db = require('../config/database');

/**
 * ‰∫ã‰ª∂Â§ÑÁêÜÂçèË∞ÉÂô® - ÂçèË∞ÉLINE AdapterÂíå‰∏öÂä°ÈÄªËæëÂ±Ç
 * ËÅåË¥£ÔºöÊé•Êî∂LINE‰∫ã‰ª∂ÔºåË∞ÉÁî®‰∏öÂä°ÊúçÂä°ÔºåËøîÂõûÂìçÂ∫îÊ∂àÊÅØ
 */
class EventHandler {
  constructor() {
    this.lineAdapter = new LineAdapter();
    this.videoService = new VideoService(db);
    this.userService = new UserService(db);
  }

  /**
   * Â§ÑÁêÜÁî®Êà∑ÂÖ≥Ê≥®‰∫ã‰ª∂
   */
  async handleFollow(event) {
    try {
      const userId = event.source.userId;
      console.log('ÔøΩÔøΩ Áî®Êà∑Ê∑ªÂä†Â•ΩÂèã:', userId);

      // Ëé∑ÂèñÁî®Êà∑profile
      const profile = await this.lineAdapter.getUserProfile(userId);
      
      // ‰∏öÂä°ÈÄªËæëÔºöÂ§ÑÁêÜÁî®Êà∑ÂÖ≥Ê≥®
      const followResult = await this.userService.handleUserFollow(userId, profile.displayName);
      
      if (!followResult.success) {
        throw new Error(followResult.error);
      }

      // ÂèëÈÄÅÊ¨¢ËøéÊ∂àÊÅØ + ËØïÁî®ÊèêÁ§∫
      const welcomeMessage = MessageTemplates.createWelcomeMessage();
      const introMessage = MessageTemplates.createTextMessage('üéÅ **ÁÑ°Êñô‰ΩìÈ®ì„Çí„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑÔºÅ**\n\nüì∏ ‰∏ãË®ò„ÅÆ„Çµ„É≥„Éó„É´ÂÜôÁúü„Åã„Çâ„ÅäÈÅ∏„Å≥„Åè„Å†„Åï„ÅÑÔºö');
      
      // Á°Æ‰øùÁî®Êà∑ÊúâRich Menu
      await this.lineAdapter.ensureUserHasRichMenu(userId);
      console.log('üîç Rich MenuËÆæÁΩÆÂÆåÊàê');

      // Áõ¥Êé•Âú®Âêå‰∏Ä‰∏™ reply ‰∏≠ÂèëÈÄÅÊºîÁ§∫ËßÜÈ¢ëÈÄâÈ°πÔºåÈÅøÂÖç push ÈÄüÁéá/ÈÖçÈ¢ùÈôêÂà∂
      const { trialPhotos } = require('../config/demo-trial-photos');
      const carouselMessage = MessageTemplates.createDemoVideoCarousel(trialPhotos);

      await this.lineAdapter.replyMessage(event.replyToken, [welcomeMessage, introMessage, carouselMessage]);
      console.log('‚úÖ Ê¨¢Ëøé+ÊèêÁ§∫+ÊºîÁ§∫ËßÜÈ¢ë ‰∏ÄÂπ∂ÂèëÈÄÅÊàêÂäü');

      return { success: true };
    } catch (error) {
      console.error('‚ùå Â§ÑÁêÜÁî®Êà∑ÂÖ≥Ê≥®Â§±Ë¥•:', error);
      return { success: false, error: error.message };
    }
  }

  /**
   * Â§ÑÁêÜÊñáÊú¨Ê∂àÊÅØ
   */
  async handleTextMessage(event) {
    try {
      const userId = event.source.userId;
      const messageText = event.message.text;

      console.log(`üìù Êî∂Âà∞ÊñáÊú¨Ê∂àÊÅØ: ${messageText} from ${userId}`);

      // Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØ
      const user = await this.userService.getUserWithState(userId);
      if (!user) {
        await this.lineAdapter.replyMessage(event.replyToken, 
          MessageTemplates.createErrorMessage('system')
        );
        return { success: false, error: 'User not found' };
      }

      // Ë∞ÉËØïÂëΩ‰ª§
      if (messageText === 'ÁãÄÊÖã' || messageText === 'debug') {
        const debugInfo = await this.userService.generateUserDebugInfo(user);
        await this.lineAdapter.replyMessage(event.replyToken, 
          MessageTemplates.createTextMessage(debugInfo)
        );
        return { success: true };
      }

      // Ê†πÊçÆÁî®Êà∑Áä∂ÊÄÅÂ§ÑÁêÜÊ∂àÊÅØ
      switch (user.current_state) {
        case 'awaiting_custom_prompt':
          return await this.handleCustomPromptInput(event, user, messageText);
          
        case 'awaiting_photo':
          const photoUploadMessage = this.lineAdapter.createPhotoUploadQuickReply('üì∏ ÂÜôÁúü„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö');
          await this.lineAdapter.replyMessage(event.replyToken, photoUploadMessage);
          return { success: true };

        default:
          await this.lineAdapter.replyMessage(event.replyToken, 
            MessageTemplates.createTextMessage('ü§î Áî≥„ÅóË®≥„Åî„Åñ„ÅÑ„Åæ„Åõ„Çì„ÄÇ‰∏ãÈÉ®„ÅÆ„É°„Éã„É•„Éº„Åã„Çâ„ÅîÂà©Áî®„Åè„Å†„Åï„ÅÑ„ÄÇ')
          );
          return { success: true };
      }
    } catch (error) {
      console.error('‚ùå Â§ÑÁêÜÊñáÊú¨Ê∂àÊÅØÂ§±Ë¥•:', error);
      await this.lineAdapter.replyMessage(event.replyToken, 
        MessageTemplates.createErrorMessage('general')
      );
      return { success: false, error: error.message };
    }
  }

  /**
   * Â§ÑÁêÜÂõæÁâáÊ∂àÊÅØ
   */
  async handleImageMessage(event) {
    try {
      const userId = event.source.userId;
      console.log('üì∏ Êî∂Âà∞ÂõæÁâáÊ∂àÊÅØ:', userId);

      // Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØ
      const user = await this.userService.getUserWithState(userId);
      if (!user) {
        await this.lineAdapter.replyMessage(event.replyToken, 
          MessageTemplates.createErrorMessage('system')
        );
        return { success: false, error: 'User not found' };
      }

      console.log('üì∏ Áî®Êà∑Áä∂ÊÄÅ:', user.current_state);

      // Ê£ÄÊü•Áî®Êà∑ËÆ¢ÈòÖÈÖçÈ¢ù
      const quota = await this.videoService.checkVideoQuota(user.id);
      if (!quota.hasQuota) {
        const quotaInfo = await this.userService.handleInsufficientQuota(user.id);
        const quotaMessage = MessageTemplates.createInsufficientQuotaCard({
          remaining: quota.remaining,
          total: quota.total,
          planType: quotaInfo.planType,
          needsUpgrade: quotaInfo.needsUpgrade,
          resetDate: quotaInfo.resetDate
        });
        await this.lineAdapter.replyMessage(event.replyToken, quotaMessage);
        // Êé®ÈÄÅËÆ¢ÈòÖÈÄâÈ°πÂç°Áâá
        const planCarousel = MessageTemplates.createPaymentOptionsCarousel(user.id);
        await this.lineAdapter.pushMessage(user.line_user_id, planCarousel);
        return { success: true };
      }

      // ‰∏ä‰º†ÂõæÁâá
      const imageUrl = await this.lineAdapter.uploadImage(event.message.id);
      if (!imageUrl) {
        await this.lineAdapter.replyMessage(event.replyToken, 
          MessageTemplates.createErrorMessage('image_upload')
        );
        return { success: false, error: 'Image upload failed' };
      }

      console.log('‚úÖ ÂõæÁâá‰∏ä‰º†ÊàêÂäü:', imageUrl);

      // Ê†πÊçÆÁî®Êà∑Áä∂ÊÄÅÂÜ≥ÂÆöÂêéÁª≠ÊµÅÁ®ã
      const prompts = this.videoService.getPresetPrompts();
      
      switch (user.current_state) {
        case 'awaiting_wave_photo':
          return await this.showGenerationConfirmation(event, user, imageUrl, prompts.wave);
        case 'awaiting_group_photo':
          return await this.showGenerationConfirmation(event, user, imageUrl, prompts.group);
        case 'awaiting_photo':
          // ‰∏™ÊÄßÂåñÊµÅÁ®ãÔºåÂ∑≤Êúâprompt
          if (user.current_prompt) {
            return await this.showGenerationConfirmation(event, user, imageUrl, user.current_prompt);
          } else {
            return await this.showPromptOptions(event, user, imageUrl);
          }
        default:
          // ÈªòËÆ§ÊÉÖÂÜµÔºöÊòæÁ§∫Âä®‰ΩúÈÄâÊã©
          await this.lineAdapter.replyMessage(event.replyToken, 
            MessageTemplates.createTextMessage('üì∏ ÂÜôÁúü„ÇíÂèó‰ø°„Åó„Åæ„Åó„ÅüÔºÅ\n\n‰∏ãÈÉ®„ÅÆ„É°„Éã„É•„Éº„Åã„ÇâÂãï‰Ωú„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö\n\nüëã ÊâãÊåØ„Çä - Ëá™ÁÑ∂„Å™Êå®Êã∂ÂãïÁîª\nü§ù ÂØÑ„ÇäÊ∑ª„ÅÑ - Ê∏©„Åã„ÅÑÂØÑ„ÇäÊ∑ª„ÅÑÂãïÁîª\nüé® ÂÄãÊÄßÂåñ - „Ç´„Çπ„Çø„É†ÂãïÁîª')
          );
          return { success: true };
      }
    } catch (error) {
      console.error('‚ùå Â§ÑÁêÜÂõæÁâáÊ∂àÊÅØÂ§±Ë¥•:', error);
      await this.lineAdapter.replyMessage(event.replyToken, 
        MessageTemplates.createErrorMessage('image_upload')
      );
      return { success: false, error: error.message };
    }
  }

  /**
   * Â§ÑÁêÜÈùûÂõæÁâáÊñá‰ª∂Ê∂àÊÅØ
   */
  async handleNonImageFile(event) {
    try {
      const fileType = event.message.type;
      let fileTypeText = '';
      
      switch (fileType) {
        case 'video':
          fileTypeText = 'ÂãïÁîª„Éï„Ç°„Ç§„É´';
          break;
        case 'audio':
          fileTypeText = 'Èü≥Â£∞„Éï„Ç°„Ç§„É´';
          break;
        case 'file':
          fileTypeText = '„Éï„Ç°„Ç§„É´';
          break;
        default:
          fileTypeText = '„Éï„Ç°„Ç§„É´';
      }
      
      const message = MessageTemplates.createTextMessage(
        `üìã ${fileTypeText}„ÇíÂèó‰ø°„Åó„Åæ„Åó„Åü„ÄÇ\n\n` +
        `‚ö†Ô∏è ÂãïÁîªÁîüÊàê„Å´„ÅØÁîªÂÉè„Éï„Ç°„Ç§„É´ÔºàJPG„ÄÅPNGÁ≠âÔºâ„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ\n\n` +
        `üì∏ ÁîªÂÉè„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`
      );
      
      await this.lineAdapter.replyMessage(event.replyToken, message);
      return { success: true };
    } catch (error) {
      console.error('‚ùå Â§ÑÁêÜÈùûÂõæÁâáÊñá‰ª∂Â§±Ë¥•:', error);
      return { success: false, error: error.message };
    }
  }

  /**
   * Â§ÑÁêÜPostback‰∫ã‰ª∂
   */
  async handlePostback(event) {
    try {
      const userId = event.source.userId;
      const postbackData = this.lineAdapter.parsePostbackData(event.postback.data);

      console.log('üìä Êî∂Âà∞Postback:', postbackData);

      // Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØ
      let user = await this.userService.getUserWithState(userId);
      if (!user) {
        // Ëá™Âä®ÂàõÂª∫Áî®Êà∑ÔºàÂèØËÉΩÊòØÈáçÊñ∞Âä†Â•ΩÂèãÊàñÊï∞ÊçÆÂ∫ìÁº∫Â§±Ôºâ
        const profile = await this.lineAdapter.getUserProfile(userId).catch(() => ({ displayName: 'User' }));
        await this.userService.ensureUserExists(userId, profile.displayName);
        user = await this.userService.getUserWithState(userId);
      }

      // Ê†πÊçÆactionÁ±ªÂûãÂ§ÑÁêÜ
      switch (postbackData.action) {
        case 'WAVE_VIDEO':
          return await this.handleWaveVideoAction(event, user);
        case 'GROUP_VIDEO':
          return await this.handleGroupVideoAction(event, user);
        case 'PERSONALIZE':
          return await this.handlePersonalizeAction(event, user);
        case 'INPUT_CUSTOM_PROMPT':
          return await this.handleInputCustomPromptAction(event, user);
        case 'RANDOM_PROMPT':
          return await this.handleRandomPromptAction(event, user);
        case 'confirm_generate':
          return await this.handleConfirmGenerate(event, user, postbackData);
        case 'demo_generate':
          return await this.handleDemoGenerate(event, user, postbackData);
        case 'switch_to_main_menu':
          return await this.handleSwitchToMainMenu(event, user);
        case 'COUPON':
          return await this.handleCouponAction(event, user);
        case 'CHANGE_PLAN':
          // ËôïÁêÜË®àÂäÉÊõ¥ÊîπË´ãÊ±ÇÔºåÈ°ØÁ§∫Ë®ÇÈñ±ÈÅ∏È†Ö
          const planCarousel = MessageTemplates.createPaymentOptionsCarousel(user.id);
          await this.lineAdapter.replyMessage(event.replyToken, planCarousel);
          return { success: true };
        case 'UPGRADE_TO_STANDARD':
          return await this.handleUpgradeToStandard(event, user);
        case 'CANCEL_UPGRADE':
          return await this.handleCancelUpgrade(event, user);
        case 'CANCEL_SUBSCRIPTION':
          return await this.handleCancelSubscription(event, user);
        case 'CONFIRM_CANCEL_SUBSCRIPTION':
          return await this.handleConfirmCancelSubscription(event, user);
        case 'CANCEL_SUBSCRIPTION_CANCEL':
          return await this.handleCancelSubscriptionCancel(event, user);
        case 'CHECK_STATUS':
          return await this.handleCheckVideoStatus(event, user);
        case 'NO_PHOTO':
          return await this.handleNoPhotoAction(event, user);
        case 'OFFICIAL_SITE':
          return await this.handleOfficialSite(event, user);
        case 'SHARE_FRIENDS':
          return await this.handleShareFriends(event, user);
        default:
          await this.lineAdapter.replyMessage(event.replyToken, 
            MessageTemplates.createTextMessage('ü§î Áî≥„ÅóË®≥„Åî„Åñ„ÅÑ„Åæ„Åõ„Çì„ÄÇ‰∏ãÈÉ®„ÅÆ„É°„Éã„É•„Éº„Åã„Çâ„ÅîÂà©Áî®„Åè„Å†„Åï„ÅÑ„ÄÇ')
          );
          return { success: true };
      }
    } catch (error) {
      console.error('‚ùå Â§ÑÁêÜPostbackÂ§±Ë¥•:', error);
      
      // Â∞ùËØïËé∑ÂèñÁî®Êà∑‰ø°ÊÅØÁî®‰∫épushÊ∂àÊÅØÔºåÈÅøÂÖçÈáçÂ§ç‰ΩøÁî®replyToken
      try {
        const userId = event.source.userId;
        await this.lineAdapter.pushMessage(userId, 
          MessageTemplates.createErrorMessage('general')
        );
      } catch (pushError) {
        console.error('‚ùå ÂèëÈÄÅÈîôËØØÊ∂àÊÅØÂ§±Ë¥•:', pushError);
        // Â¶ÇÊûúpush‰πüÂ§±Ë¥•‰∫ÜÔºåÂ∞ùËØïreplyÔºà‰ΩÜÂèØËÉΩ‰ºöÂ§±Ë¥•Ôºâ
        try {
          await this.lineAdapter.replyMessage(event.replyToken, 
            MessageTemplates.createErrorMessage('general')
          );
        } catch (replyError) {
          console.error('‚ùå ReplyÈîôËØØÊ∂àÊÅØ‰πüÂ§±Ë¥•:', replyError);
        }
      }
      
      return { success: false, error: error.message };
    }
  }

  // ===== ÁßÅÊúâËæÖÂä©ÊñπÊ≥ï =====

  /**
   * ÂèëÈÄÅÊºîÁ§∫ËßÜÈ¢ëÈÄâÈ°π
   */
  async sendDemoVideos(userId) {
    try {
      console.log('üéÅ ÂºÄÂßãÂèëÈÄÅÊºîÁ§∫ËßÜÈ¢ëÂà∞Áî®Êà∑:', userId);
      console.log('üîç ÂΩìÂâçÊó∂Èó¥:', new Date().toISOString());
      
      const { trialPhotos } = require('../config/demo-trial-photos');
      console.log('üìã Âä†ËΩΩÊºîÁ§∫ËßÜÈ¢ëÈÖçÁΩÆÔºåÂÖ±', trialPhotos.length, '‰∏™ËßÜÈ¢ë');
      
      const carouselMessage = MessageTemplates.createDemoVideoCarousel(trialPhotos);
      console.log('‚úÖ ËΩÆÊí≠Ê∂àÊÅØÂàõÂª∫ÊàêÂäüÔºåÂç°ÁâáÊï∞Èáè:', carouselMessage.contents.contents.length);
      
      console.log('üì§ ÂáÜÂ§áÂèëÈÄÅÊ∂àÊÅØÂà∞Áî®Êà∑:', userId);
      await this.lineAdapter.pushMessage(userId, [carouselMessage]);
      console.log('‚úÖ ÊºîÁ§∫ËßÜÈ¢ëÈÄâÈ°πÂèëÈÄÅÂÆåÊàê');
    } catch (error) {
      console.error('‚ùå ÂèëÈÄÅÊºîÁ§∫ËßÜÈ¢ëÈÄâÈ°πÂ§±Ë¥•:', error);
      console.error('ÈîôËØØËØ¶ÊÉÖ:', error.stack);
      throw error;
    }
  }

  /**
   * ÊòæÁ§∫ÁîüÊàêÁ°ÆËÆ§Âç°Áâá
   */
  async showGenerationConfirmation(event, user, imageUrl, prompt) {
    try {
      // Áç≤ÂèñÁî®Êà∂ÈÖçÈ°ç‰ø°ÊÅØ
      const quota = await this.videoService.checkVideoQuota(user.id);
      
      const confirmationCard = MessageTemplates.createGenerationConfirmCard(imageUrl, prompt, quota);
      await this.lineAdapter.replyMessage(event.replyToken, confirmationCard);
      // Â∞áÂúñÁâáËàápromptÊö´Â≠òÊñºÁî®Êà∂ÁãÄÊÖãÔºå‰æõÁ¢∫Ë™çÊåâÈàïÂæåËÆÄÂèñ
      await this.userService.setUserState(
        user.id,
        'awaiting_confirm',
        JSON.stringify({ prompt, imageUrl })
      );
      
      return { success: true };
    } catch (error) {
      console.error('‚ùå ÊòæÁ§∫Á°ÆËÆ§Âç°ÁâáÂ§±Ë¥•:', error);
      throw error;
    }
  }

  /**
   * ÊòæÁ§∫promptÈÄâÈ°πÔºàÁÆÄÂåñÁâàÔºâ
   */
  async showPromptOptions(event, user, imageUrl) {
    try {
      await this.lineAdapter.replyMessage(event.replyToken, 
        MessageTemplates.createTextMessage('üì∏ ÂÜôÁúü„ÇíÂèó‰ø°„Åó„Åæ„Åó„ÅüÔºÅ\n\n‰∏ãÈÉ®„ÅÆ„É°„Éã„É•„Éº„Åã„Çâ„ÄåÂÄãÊÄßÂåñ„Äç„ÇíÈÅ∏Êäû„Åó„Å¶„Éó„É≠„É≥„Éó„Éà„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ')
      );
      return { success: true };
    } catch (error) {
      console.error('‚ùå ÊòæÁ§∫promptÈÄâÈ°πÂ§±Ë¥•:', error);
      throw error;
    }
  }

  // ===== Âä®‰ΩúÂ§ÑÁêÜÊñπÊ≥ï =====

  async handleWaveVideoAction(event, user) {
    // Ê£ÄÊü•Áî®Êà∑ËÆ¢ÈòÖÁä∂ÊÄÅ
    const quota = await this.videoService.checkVideoQuota(user.id);
    if (!quota.hasQuota) {
      await this.lineAdapter.replyMessage(event.replyToken, 
        MessageTemplates.createTextMessage('üôá‚Äç‚ôÄÔ∏è Áî≥„ÅóË®≥„Åî„Åñ„ÅÑ„Åæ„Åõ„Çì„ÄÇÂãïÁîªÁîüÊàê„Çµ„Éº„Éì„Çπ„Çí„ÅîÂà©Áî®„ÅÑ„Åü„Å†„Åè„Å´„ÅØ„ÄÅ„Åæ„Åö„Éó„É©„É≥„Å´„ÅîÂä†ÂÖ•„ÅÑ„Åü„Å†„ÅèÂøÖË¶Å„Åå„Åî„Åñ„ÅÑ„Åæ„Åô„ÄÇ\n\n‰∏ãË®ò„Åã„Çâ„ÅäÂ•Ω„Åø„ÅÆ„Éó„É©„É≥„Çí„ÅäÈÅ∏„Å≥„Åè„Å†„Åï„ÅÑ„ÄÇ')
      );
      
      // Êé®ÈÄÅËÆ¢ÈòÖÈÄâÈ°πÂç°Áâá
      const planCarousel = MessageTemplates.createPaymentOptionsCarousel(user.id);
      await this.lineAdapter.pushMessage(user.line_user_id, planCarousel);
      return { success: true };
    }

    const messages = MessageTemplates.createActionSelectionMessages('wave');
    const photoUploadReply = this.lineAdapter.createPhotoUploadQuickReply();
    
    await this.lineAdapter.replyMessage(event.replyToken, [...messages, photoUploadReply]);
    await this.userService.setUserState(user.id, 'awaiting_wave_photo');
    
    return { success: true };
  }

  async handleGroupVideoAction(event, user) {
    // Ê£ÄÊü•Áî®Êà∑ËÆ¢ÈòÖÁä∂ÊÄÅ
    const quota = await this.videoService.checkVideoQuota(user.id);
    if (!quota.hasQuota) {
      await this.lineAdapter.replyMessage(event.replyToken, 
        MessageTemplates.createTextMessage('üôá‚Äç‚ôÄÔ∏è Áî≥„ÅóË®≥„Åî„Åñ„ÅÑ„Åæ„Åõ„Çì„ÄÇÂãïÁîªÁîüÊàê„Çµ„Éº„Éì„Çπ„Çí„ÅîÂà©Áî®„ÅÑ„Åü„Å†„Åè„Å´„ÅØ„ÄÅ„Åæ„Åö„Éó„É©„É≥„Å´„ÅîÂä†ÂÖ•„ÅÑ„Åü„Å†„ÅèÂøÖË¶Å„Åå„Åî„Åñ„ÅÑ„Åæ„Åô„ÄÇ\n\n‰∏ãË®ò„Åã„Çâ„ÅäÂ•Ω„Åø„ÅÆ„Éó„É©„É≥„Çí„ÅäÈÅ∏„Å≥„Åè„Å†„Åï„ÅÑ„ÄÇ')
      );
      
      // Êé®ÈÄÅËÆ¢ÈòÖÈÄâÈ°πÂç°Áâá
      const planCarousel = MessageTemplates.createPaymentOptionsCarousel(user.id);
      await this.lineAdapter.pushMessage(user.line_user_id, planCarousel);
      return { success: true };
    }

    const messages = MessageTemplates.createActionSelectionMessages('group');
    const photoUploadReply = this.lineAdapter.createPhotoUploadQuickReply();
    
    await this.lineAdapter.replyMessage(event.replyToken, [...messages, photoUploadReply]);
    await this.userService.setUserState(user.id, 'awaiting_group_photo');
    
    return { success: true };
  }

  async handlePersonalizeAction(event, user) {
    // Ê£ÄÊü•Áî®Êà∑ËÆ¢ÈòÖÁä∂ÊÄÅ
    const quota = await this.videoService.checkVideoQuota(user.id);
    if (!quota.hasQuota) {
      await this.lineAdapter.replyMessage(event.replyToken, 
        MessageTemplates.createTextMessage('üôá‚Äç‚ôÄÔ∏è Áî≥„ÅóË®≥„Åî„Åñ„ÅÑ„Åæ„Åõ„Çì„ÄÇÂãïÁîªÁîüÊàê„Çµ„Éº„Éì„Çπ„Çí„ÅîÂà©Áî®„ÅÑ„Åü„Å†„Åè„Å´„ÅØ„ÄÅ„Åæ„Åö„Éó„É©„É≥„Å´„ÅîÂä†ÂÖ•„ÅÑ„Åü„Å†„ÅèÂøÖË¶Å„Åå„Åî„Åñ„ÅÑ„Åæ„Åô„ÄÇ\n\n‰∏ãË®ò„Åã„Çâ„ÅäÂ•Ω„Åø„ÅÆ„Éó„É©„É≥„Çí„ÅäÈÅ∏„Å≥„Åè„Å†„Åï„ÅÑ„ÄÇ')
      );
      
      // Êé®ÈÄÅËÆ¢ÈòÖÈÄâÈ°πÂç°Áâá
      const planCarousel = MessageTemplates.createPaymentOptionsCarousel(user.id);
      await this.lineAdapter.pushMessage(user.line_user_id, planCarousel);
      return { success: true };
    }

    const messages = MessageTemplates.createActionSelectionMessages('personalize');
    
    // Ê∑ªÂä†Quick ReplyÈÄâÈ°π
    messages[0].quickReply = {
      items: [
        {
          type: 'action',
          action: {
            type: 'postback',
            label: 'üé≤ „É©„É≥„ÉÄ„É†„Éó„É≠„É≥„Éó„Éà',
            data: 'action=RANDOM_PROMPT'
          }
        },
        {
          type: 'action',
          action: {
            type: 'postback',
            label: '‚úèÔ∏è Ëá™ÂàÜ„ÅßÂÖ•Âäõ„Åô„Çã',
            data: 'action=INPUT_CUSTOM_PROMPT',
            inputOption: 'openKeyboard'
          }
        }
      ]
    };

    await this.lineAdapter.replyMessage(event.replyToken, messages);
    await this.userService.setUserState(user.id, 'awaiting_custom_prompt_selection');
    
    return { success: true };
  }

  async handleCustomPromptInput(event, user, promptText) {
    const confirmMessage = MessageTemplates.createTextMessage(`‚úÖ „Éó„É≠„É≥„Éó„Éà„ÇíË®≠ÂÆö„Åó„Åæ„Åó„ÅüÔºö\n"${promptText}"`);
    const photoUploadReply = this.lineAdapter.createPhotoUploadQuickReply();
    
    await this.lineAdapter.replyMessage(event.replyToken, [confirmMessage, photoUploadReply]);
    await this.userService.setUserState(user.id, 'awaiting_photo', promptText);
    
    return { success: true };
  }

  async handleRandomPromptAction(event, user) {
    const randomPrompt = this.videoService.generateRandomPrompt();
    const confirmMessage = MessageTemplates.createTextMessage(`‚ú® „É©„É≥„ÉÄ„É†„Éó„É≠„É≥„Éó„ÉàÔºö\n"${randomPrompt}"`);
    const photoUploadReply = this.lineAdapter.createPhotoUploadQuickReply();
    
    await this.lineAdapter.replyMessage(event.replyToken, [confirmMessage, photoUploadReply]);
    await this.userService.setUserState(user.id, 'awaiting_photo', randomPrompt);
    
    return { success: true };
  }

  async handleInputCustomPromptAction(event, user) {
    try {
      // Ë®≠ÁΩÆÁî®Êà∂ÁãÄÊÖãÁÇ∫Á≠âÂæÖËá™ÂÆöÁæ©promptËº∏ÂÖ•
      await this.userService.setUserState(user.id, 'awaiting_custom_prompt');
      
      // ÁôºÈÄÅÁ∞°ÊΩîÁöÑÂºïÂ∞éÊ∂àÊÅØ
      const instructionMessage = MessageTemplates.createTextMessage(
        '‚úèÔ∏è ÂãïÁîª„ÅÆ„Çπ„Çø„Ç§„É´„ÇÑÈõ∞Âõ≤Ê∞ó„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö'
      );
      
      await this.lineAdapter.replyMessage(event.replyToken, instructionMessage);
      
      return { success: true };
    } catch (error) {
      console.error('‚ùå Â§ÑÁêÜËá™ÂÆö‰πâpromptËæìÂÖ•Â§±Ë¥•:', error);
      await this.lineAdapter.replyMessage(event.replyToken, 
        MessageTemplates.createErrorMessage('general')
      );
      return { success: false, error: error.message };
    }
  }

  async handleConfirmGenerate(event, user, data) {
    try {
      // ÂÖàÊ£ÄÊü•Áî®Êà∑ÊòØÂê¶Â∑≤ÊúâÊ≠£Âú®ËøõË°åÁöÑ‰ªªÂä°
      const pendingTasks = await this.videoService.db.getUserPendingTasks(user.line_user_id);
      if (pendingTasks.length > 0) {
        await this.lineAdapter.replyMessage(event.replyToken, {
          type: 'text',
          text: 'üé¨ ÁèæÂú®ÂãïÁîª„ÇíÁîüÊàê‰∏≠„Åß„Åô„ÄÇ„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ...\n\n‚è±Ô∏è ÁîüÊàêÂÆå‰∫Ü„Åæ„Åß‰ªä„Åó„Å∞„Çâ„Åè„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ„ÄÇË§áÊï∞„ÅÆÂãïÁîª„ÇíÂêåÊôÇ„Å´ÁîüÊàê„Åô„Çã„Åì„Å®„ÅØ„Åß„Åç„Åæ„Åõ„Çì„ÄÇ'
        });
        return { success: false, error: 'User already has pending tasks' };
      }

      // Âæû‰ΩøÁî®ËÄÖÁãÄÊÖãÂèñÂá∫Êö´Â≠òË≥áÊñô
      let prompt = null;
      let imageUrl = null;
      try {
        const cached = JSON.parse(user.current_prompt || '{}');
        prompt = cached.prompt;
        imageUrl = cached.imageUrl;
      } catch (_) {}

      // Ê™¢Êü•ÂøÖË¶ÅÂèÉÊï∏ÔºöpromptÂøÖÈ†àÂ≠òÂú®ÔºåimageUrlÂèØ‰ª•ÁÇ∫null
      if (!prompt) {
        await this.lineAdapter.replyMessage(event.replyToken, 
          MessageTemplates.createErrorMessage('video_generation')
        );
        return { success: false, error: 'Missing prompt' };
      }

      // È™åËØÅÂèÇÊï∞
      const validation = this.videoService.validateVideoParams(imageUrl, prompt);
      if (!validation.isValid) {
        await this.lineAdapter.replyMessage(event.replyToken, 
          MessageTemplates.createErrorMessage('video_generation')
        );
        return { success: false, error: validation.errors.join(', ') };
      }

      // 1. Á´ãÂç≥ÂàáÊç¢Âà∞processing menuÁªôÁî®Êà∑Âç≥Êó∂ÂèçÈ¶à
      await this.lineAdapter.switchToProcessingMenu(user.line_user_id);

      // 2. ÂàõÂª∫ËßÜÈ¢ë‰ªªÂä°
      const subscription = await this.userService.getUserSubscription(user.id);
      const taskResult = await this.videoService.createVideoTask(user.id, {
        imageUrl,
        prompt,
        subscriptionId: subscription?.id
      });

      if (!taskResult.success) {
        await this.lineAdapter.replyMessage(event.replyToken, 
          MessageTemplates.createErrorMessage('video_generation')
        );
        return { success: false, error: 'Failed to create video task' };
      }

      // 3. ÂêØÂä®ËßÜÈ¢ëÁîüÊàêÂπ∂Ëé∑ÂèñtaskId
      const VideoGenerator = require('../services/video-generator');
      const videoGenerator = new VideoGenerator(this.videoService.db);
      
      // Ë∞ÉÁî®KIE.AI API
      const apiResult = await videoGenerator.callRunwayApi(imageUrl, prompt);
      if (!apiResult.success) {
        // APIË∞ÉÁî®Â§±Ë¥•ÔºåÊÅ¢Â§çÈÖçÈ¢ùÂπ∂ÈÄöÁü•Áî®Êà∑
        await this.videoService.handleVideoFailure(taskResult.videoRecordId, apiResult.error, true);
        await this.lineAdapter.replyMessage(event.replyToken, {
          type: 'text',
          text: `‚ùå ÂãïÁîªÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ\n\nË©≥Á¥∞: ${apiResult.error}\n\n‚úÖ Âà©Áî®Êû†„ÅØÊ∂àË≤ª„Åï„Çå„Å¶„Åä„Çä„Åæ„Åõ„Çì„ÄÇ`
        });
        await this.lineAdapter.switchToMainMenu(user.line_user_id);
        return { success: false, error: apiResult.error };
      }

      // 4. ÂêåÊ≠•ËΩÆËØ¢5ÂàÜÈíü
      const maxPollingTime = 5 * 60 * 1000; // 5ÂàÜÈíü
      const pollInterval = 10000; // 10Áßí
      const startTime = Date.now();
      
      let finalResult = null;
      let pollErrorCount = 0;
      const maxPollErrors = 5; // ÊúÄÂ§öÂÖÅËÆ∏5Ê¨°ËΩÆËØ¢ÈîôËØØ
      
      while (Date.now() - startTime < maxPollingTime) {
        await new Promise(resolve => setTimeout(resolve, pollInterval));
        
        try {
          const status = await videoGenerator.checkTaskStatus(apiResult.taskId);
          
          if (status.state === 'success') {
            // ÁîüÊàêÊàêÂäü
            await this.videoService.updateVideoStatus(taskResult.videoRecordId, 'completed', status.videoUrl);
            finalResult = {
              success: true,
              videoUrl: status.videoUrl,
              thumbnailUrl: status.thumbnailUrl
            };
            break;
          } else if (status.state === 'failed' || status.state === 'error') {
            // ÁîüÊàêÂ§±Ë¥•ÔºåÊÅ¢Â§çÈÖçÈ¢ù
            await this.videoService.handleVideoFailure(taskResult.videoRecordId, status.message, true);
            finalResult = {
              success: false,
              error: status.message || 'ÂãïÁîªÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü'
            };
            break;
          }
          
          // ÈáçÁΩÆÈîôËØØËÆ°Êï∞Âô®ÔºàÊàêÂäüËΩÆËØ¢Ôºâ
          pollErrorCount = 0;
          // ÁªßÁª≠ËΩÆËØ¢...
        } catch (pollError) {
          console.error('‚ùå ËΩÆËØ¢ÈîôËØØ:', pollError);
          pollErrorCount++;
          
          // Â¶ÇÊûúËΩÆËØ¢ÈîôËØØÊ¨°Êï∞ËøáÂ§öÔºåËÆ§‰∏∫‰ªªÂä°Â§±Ë¥•Âπ∂ÊÅ¢Â§çÈÖçÈ¢ù
          if (pollErrorCount >= maxPollErrors) {
            console.error('‚ùå ËΩÆËØ¢ÈîôËØØÊ¨°Êï∞ËøáÂ§öÔºåÊÅ¢Â§çÈÖçÈ¢ù');
            await this.videoService.handleVideoFailure(taskResult.videoRecordId, 'ËΩÆËØ¢ÊúçÂä°ÂºÇÂ∏∏', true);
            finalResult = {
              success: false,
              error: 'ÂãïÁîªÁîüÊàê„Çµ„Éº„Éì„Çπ„Å´Êé•Á∂ö„Åß„Åç„Åæ„Åõ„Çì'
            };
            break;
          }
          
          // ÁªßÁª≠ËΩÆËØ¢Ôºå‰∏çÁ´ãÂç≥Â§±Ë¥•
        }
      }

      // 5. Â§ÑÁêÜÁªìÊûú
      if (finalResult) {
        if (finalResult.success) {
          // ÊàêÂäüÔºöÂèëÈÄÅËßÜÈ¢ë
          const completedMessages = MessageTemplates.createVideoStatusMessages('completed', {
            videoUrl: finalResult.videoUrl,
            thumbnailUrl: finalResult.thumbnailUrl
          });
          await this.lineAdapter.replyMessage(event.replyToken, completedMessages);
        } else {
          // Â§±Ë¥•ÔºöÂèëÈÄÅÈîôËØØ‰ø°ÊÅØ
          await this.lineAdapter.replyMessage(event.replyToken, {
            type: 'text',
            text: `‚ùå ÂãïÁîªÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ\n\nË©≥Á¥∞: ${finalResult.error}\n\n‚úÖ Âà©Áî®Êû†„ÅØÊ∂àË≤ª„Åï„Çå„Å¶„Åä„Çä„Åæ„Åõ„Çì„ÄÇ`
          });
        }
        // ÂàáÊç¢Âõû‰∏ªËèúÂçï
        await this.lineAdapter.switchToMainMenu(user.line_user_id);
      } else {
        // Ë∂ÖÊó∂ÔºöÂëäÁü•Áî®Êà∑ÁÇπÂáªprocessing menuÊü•ËØ¢ËøõÂ∫¶
        await this.lineAdapter.replyMessage(event.replyToken, {
          type: 'text',
          text: 'üé¨ ÂãïÁîªÁîüÊàê‰∏≠„Åß„Åô...\n\n‚è±Ô∏è ÁîüÊàê„Å´ÈÄöÂ∏∏„Çà„ÇäÊôÇÈñì„Åå„Åã„Åã„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇ\n\nüì± ‰∏ã„ÅÆ„É°„Éã„É•„Éº„Çí„Çø„ÉÉ„Éó„Åó„Å¶ÈÄ≤Êçó„ÇíÁ¢∫Ë™ç„Åß„Åç„Åæ„Åô„ÄÇ'
        });
        // ‰øùÊåÅprocessing menuÔºåÁ≠âÂæÖÁî®Êà∑ÁÇπÂáªÊü•ËØ¢
      }

      // ËÆ∞ÂΩï‰∫§‰∫í
      await this.userService.logUserInteraction(user.line_user_id, user.id, 'video_generation_started', {
        imageUrl, prompt, videoRecordId: taskResult.videoRecordId
      });

      // Ê∏ÖÈô§Áî®Êà∑Áä∂ÊÄÅ
      await this.userService.clearUserState(user.id);

      return { success: true };
    } catch (error) {
      console.error('‚ùå Â§ÑÁêÜÁ°ÆËÆ§ÁîüÊàêÂ§±Ë¥•:', error);
      try {
        // üö® ÈáçË¶ÅÔºöÂ¶ÇÊûúÂ∑≤ÁªèÂàõÂª∫‰∫ÜËßÜÈ¢ë‰ªªÂä°ÔºåÂøÖÈ°ªÊÅ¢Â§çÈÖçÈ¢ù
        if (taskResult && taskResult.success && taskResult.videoRecordId) {
          console.log('üîÑ Á≥ªÁªüÈîôËØØÔºåÊÅ¢Â§çÁî®Êà∑ÈÖçÈ¢ù:', taskResult.videoRecordId);
          await this.videoService.handleVideoFailure(taskResult.videoRecordId, 'Á≥ªÁªüÈîôËØØ', true);
        }
        
        await this.lineAdapter.replyMessage(event.replyToken, {
          type: 'text',
          text: '‚ùå „Ç∑„Çπ„ÉÜ„É†„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ\n\n‚úÖ Âà©Áî®Êû†„ÅØÊ∂àË≤ª„Åï„Çå„Å¶„Åä„Çä„Åæ„Åõ„Çì„ÄÇ\n\nüîÑ „Åó„Å∞„Çâ„Åè„Åó„Å¶„Åã„ÇâÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ'
        });
        await this.lineAdapter.switchToMainMenu(user.line_user_id);
      } catch (replyError) {
        console.error('‚ùå ÂèëÈÄÅÈîôËØØÂõûÂ§çÂ§±Ë¥•:', replyError);
      }
      return { success: false, error: error.message };
    }
  }

  async handleDemoGenerate(event, user, data) {
    try {
      const photoId = data.photo_id;
      
      // 1. Âπ∂Ë°åÊâßË°åÔºöÁ´ãÂç≥ÂàáÊç¢processing menu + ÂáÜÂ§ádemoÊï∞ÊçÆ
      const [_, selectedPhoto] = await Promise.all([
        // Á´ãÂç≥ÂàáÊç¢Âà∞Â§ÑÁêÜ‰∏≠ËèúÂçï - ÁªôÁî®Êà∑Âç≥Êó∂ÂèçÈ¶à
        this.lineAdapter.switchToProcessingMenu(user.line_user_id),
        // ÂêåÊó∂ÂáÜÂ§ádemoËßÜÈ¢ë‰ø°ÊÅØ
        (() => {
          const { trialPhotos } = require('../config/demo-trial-photos');
          return trialPhotos.find(photo => photo.id === photoId);
        })()
      ]);

      // 2. Á≠âÂæÖ15ÁßíÔºàÊ®°ÊãüÁîüÊàêËøáÁ®ãÔºâ
      await new Promise(resolve => setTimeout(resolve, 15000));

      // 3. Â§ÑÁêÜdemoËßÜÈ¢ë
      if (selectedPhoto) {
        // 4. ÂàõÂª∫ÂÆåÊàêÊ∂àÊÅØÂ∫èÂàó
        const demoCompletedMessages = MessageTemplates.createVideoStatusMessages('demo_completed', {
          videoUrl: selectedPhoto.demo_video_url,
          thumbnailUrl: selectedPhoto.image_url
        });
        
        // 5. ÁªÑÂêàÊâÄÊúâÊ∂àÊÅØÔºàcompleted + guideÔºâ
        const allMessages = [];
        
        // Ê∑ªÂä†ÂÆåÊàêÊ∂àÊÅØ
        if (Array.isArray(demoCompletedMessages)) {
          allMessages.push(...demoCompletedMessages);
        } else {
          allMessages.push(demoCompletedMessages);
        }
        
        // Ê∑ªÂä†ÊåáÂØºÊ∂àÊÅØ
        allMessages.push({
          type: 'text',
          text: '‚úÖ „ÉÜ„Çπ„ÉàÂãïÁîª„ÅÆÁîüÊàê„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ\n\n„ÅÑ„Åã„Åå„Åß„Åó„Çá„ÅÜ„ÅãÔºü„ÅîËá™Ë∫´„ÅÆÂÜôÁúü„ÅßÂãïÁîª„ÇíÁîüÊàê„Åó„Åü„ÅÑÂ†¥Âêà„ÅØ„ÄÅ‰∏ã„ÅÆ„É°„Éã„É•„Éº„Åã„Çâ„ÅäÈÅ∏„Å≥„Åè„Å†„Åï„ÅÑ„ÄÇ'
        });

        // 6. Âπ∂Ë°åÊâßË°åÔºöÂèëÈÄÅÊ∂àÊÅØ + ÂàáÊç¢Âõû‰∏ªËèúÂçï
        await Promise.all([
          // ‰ΩøÁî®replyMessageÂèëÈÄÅÂÆåÊï¥Ê∂àÊÅØÂ∫èÂàóÔºàÂÆåÂÖ®ÂÖçË¥πÔºâ
          this.lineAdapter.replyMessage(event.replyToken, allMessages),
          // ÂêåÊó∂ÂàáÊç¢Âõû‰∏ªËèúÂçï
          this.lineAdapter.switchToMainMenu(user.line_user_id)
        ]);
      } else {
        // Â§ÑÁêÜÈîôËØØÊÉÖÂÜµ
        console.error('‚ùå Êâæ‰∏çÂà∞ÊåáÂÆöÁöÑdemoÁÖßÁâá:', photoId);
        const errorMessage = MessageTemplates.createErrorMessage('video_generation');
        await Promise.all([
          this.lineAdapter.replyMessage(event.replyToken, errorMessage),
          this.lineAdapter.switchToMainMenu(user.line_user_id)
        ]);
      }
      
      return { success: true };
    } catch (error) {
      console.error('‚ùå Â§ÑÁêÜÊºîÁ§∫ÁîüÊàêÂ§±Ë¥•:', error);
      // Â¶ÇÊûúÂá∫ÈîôÔºåÂ∞ùËØïÂàáÊç¢Âõû‰∏ªËèúÂçïÂπ∂ÂèëÈÄÅÈîôËØØÊ∂àÊÅØ
      try {
        await this.lineAdapter.switchToMainMenu(user.line_user_id);
        const errorMessage = MessageTemplates.createErrorMessage('video_generation');
        await this.lineAdapter.replyMessage(event.replyToken, errorMessage);
      } catch (recoveryError) {
        console.error('‚ùå ÈîôËØØÊÅ¢Â§ç‰πüÂ§±Ë¥•:', recoveryError);
        // ÈùôÈªòÂ§±Ë¥•
      }
      throw error;
    }
  }

  async handleCouponAction(event, user) {
    try {
      console.log(`üé´ Áî®Êà∑ ${user.id} ÁÇπÂáª‰ºòÊÉ†Âà∏ÊåâÈíÆ`);
      
      // Ê™¢Êü•Áî®Êà∂Ë®ÇÈñ±ÁãÄÊÖã
      const subscription = await this.userService.getUserSubscription(user.id);
      console.log('üìã Áî®Êà∑ËÆ¢ÈòÖÁä∂ÊÄÅ:', subscription);
      
      if (!subscription) {
        // Ê≤íÊúâË®ÇÈñ±ÔºåÈ°ØÁ§∫Ë®ÇÈñ±Ë®àÂäÉÈÅ∏È†Ö
        console.log('üí≥ ÊòæÁ§∫ÊîØ‰ªòÈÄâÈ°πÂç°Áâá');
        const planCarousel = MessageTemplates.createPaymentOptionsCarousel(user.id);
        await this.lineAdapter.replyMessage(event.replyToken, planCarousel);
      } else {
        // Â∑≤ÊúâË®ÇÈñ±ÔºåÈ°ØÁ§∫Áï∂ÂâçÁãÄÊÖã
        if (subscription.plan_type === 'standard') {
          // Standard Áî®Êà∂ÔºåÂÉÖÈ°ØÁ§∫ÁãÄÊÖã
          console.log('‚≠ê ÊòæÁ§∫StandardËÆ¢ÈòÖÁä∂ÊÄÅÂç°Áâá');
          const statusMessage = MessageTemplates.createSubscriptionStatusMessage(subscription);
          await this.lineAdapter.replyMessage(event.replyToken, statusMessage);
        } else if (subscription.plan_type === 'trial') {
          // Trial Áî®Êà∂ÔºåË©¢ÂïèÊòØÂê¶ÂçáÁ¥ö
          console.log('üÜô ÊòæÁ§∫TrialÂçáÁ∫ßÊèêÁ§∫Âç°Áâá');
          const upgradeCard = MessageTemplates.createUpgradePromptCard(subscription);
          await this.lineAdapter.replyMessage(event.replyToken, upgradeCard);
        }
      }
      
      return { success: true };
    } catch (error) {
      console.error('‚ùå ËôïÁêÜÂÑ™ÊÉ†Âà∏Âãï‰ΩúÂ§±Êïó:', error);
      await this.lineAdapter.replyMessage(event.replyToken, 
        MessageTemplates.createErrorMessage('system_error')
      );
      return { success: false, error: error.message };
    }
  }

  async handleWebsiteAction(event, user) {
    const websiteCard = MessageTemplates.createWebsiteCard();
    await this.lineAdapter.replyMessage(event.replyToken, websiteCard);
    return { success: true };
  }

  async handleShareAction(event, user) {
    const shareCard = MessageTemplates.createShareCard();
    await this.lineAdapter.replyMessage(event.replyToken, shareCard);
    return { success: true };
  }

  async handleUpgradeToStandard(event, user) {
    try {
      // È°ØÁ§∫ Standard Plan Ë®ÇÈñ±ÈÅ∏È†Ö
      const standardUrl = process.env.STRIPE_STANDARD_URL || 'https://buy.stripe.com/fZu6oGfwvaNU9Th2HZcs80b';
      
      const upgradeMessage = {
        type: 'flex',
        altText: '‚¨ÜÔ∏è Standard Plan ÂçáÁ¥ö',
        contents: {
          type: 'bubble',
          body: {
            type: 'box',
            layout: 'vertical',
            contents: [
              {
                type: 'text',
                text: '‚¨ÜÔ∏è Standard Plan',
                weight: 'bold',
                size: 'xl',
                color: '#42C76A'
              },
              {
                type: 'text',
                text: '¬•2,980/Êúà„Åß100Êú¨„ÅÆÂãïÁîªÁîüÊàê',
                size: 'md',
                color: '#666666',
                margin: 'md'
              }
            ]
          },
          footer: {
            type: 'box',
            layout: 'vertical',
            contents: [
              {
                type: 'button',
                style: 'primary',
                color: '#42C76A',
                action: {
                  type: 'uri',
                  label: '‰ªä„Åô„Åê„Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„Éâ',
                  uri: standardUrl
                }
              }
            ]
          }
        }
      };
      
      await this.lineAdapter.replyMessage(event.replyToken, upgradeMessage);
      return { success: true };
    } catch (error) {
      console.error('‚ùå ËôïÁêÜÂçáÁ¥öÂ§±Êïó:', error);
      return { success: false, error: error.message };
    }
  }

  async handleCancelUpgrade(event, user) {
    try {
      const cancelMessage = MessageTemplates.createTextMessage('‚úÖ „Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„Éâ„Çí„Ç≠„É£„É≥„Çª„É´„Åó„Åæ„Åó„Åü„ÄÇ\n\nÁèæÂú®„ÅÆTrial Plan„ÇíÂºï„ÅçÁ∂ö„Åç„ÅîÂà©Áî®„Åè„Å†„Åï„ÅÑ„ÄÇ');
      await this.lineAdapter.replyMessage(event.replyToken, cancelMessage);
      return { success: true };
    } catch (error) {
      console.error('‚ùå ËôïÁêÜÂèñÊ∂àÂçáÁ¥öÂ§±Êïó:', error);
      return { success: false, error: error.message };
    }
  }

  async handleCancelSubscription(event, user) {
    try {
      console.log(`üö´ Áî®Êà∑ ${user.id} ËØ∑Ê±ÇÂèñÊ∂àËÆ¢ÈòÖ`);
      
      // Ë∞ÉÁî®APIËé∑ÂèñÂÆ¢Êà∑Èó®Êà∑ÈìæÊé•
      const axios = require('axios');
      const baseUrl = process.env.VERCEL_URL ? `https://${process.env.VERCEL_URL}` : 'https://line-photo-revival-bot.vercel.app';
      
      try {
        const response = await axios.get(`${baseUrl}/api/payment/create-portal-session?userId=${user.id}`);
        
        if (response.data.success) {
          // ÂèëÈÄÅÂåÖÂê´StripeÂÆ¢Êà∑Èó®Êà∑ÈìæÊé•ÁöÑÊ∂àÊÅØ
          const portalMessage = MessageTemplates.createFlexMessage(
            '„Çµ„Éñ„Çπ„ÇØ„É™„Éó„Ç∑„Éß„É≥ÁÆ°ÁêÜ',
            {
              type: 'bubble',
              body: {
                type: 'box',
                layout: 'vertical',
                contents: [
                  {
                    type: 'text',
                    text: 'üè™ „Çµ„Éñ„Çπ„ÇØ„É™„Éó„Ç∑„Éß„É≥ÁÆ°ÁêÜ',
                    weight: 'bold',
                    size: 'lg',
                    color: '#333333'
                  },
                  {
                    type: 'separator',
                    margin: 'md'
                  },
                  {
                    type: 'text',
                    text: 'Stripe„ÅÆÂÆâÂÖ®„Å™„Éö„Éº„Ç∏„Åß„Çµ„Éñ„Çπ„ÇØ„É™„Éó„Ç∑„Éß„É≥„ÇíÁÆ°ÁêÜ„Åß„Åç„Åæ„Åô„ÄÇ',
                    size: 'sm',
                    color: '#666666',
                    margin: 'md',
                    wrap: true
                  },
                  {
                    type: 'text',
                    text: '‚Ä¢ „Çµ„Éñ„Çπ„ÇØ„É™„Éó„Ç∑„Éß„É≥„ÅÆËß£Á¥Ñ\n‚Ä¢ „ÅäÊîØÊâï„ÅÑÊñπÊ≥ï„ÅÆÂ§âÊõ¥\n‚Ä¢ Ë´ãÊ±ÇÂ±•Ê≠¥„ÅÆÁ¢∫Ë™ç',
                    size: 'sm',
                    color: '#666666',
                    margin: 'md',
                    wrap: true
                  }
                ]
              },
              footer: {
                type: 'box',
                layout: 'vertical',
                contents: [
                  {
                    type: 'button',
                    style: 'primary',
                    color: '#FF6B6B',
                    action: {
                      type: 'uri',
                      uri: response.data.portal_url,
                      label: 'üè™ ÁÆ°ÁêÜ„Éö„Éº„Ç∏„ÇíÈñã„Åè'
                    }
                  }
                ]
              }
            }
          );
          
          await this.lineAdapter.replyMessage(event.replyToken, portalMessage);
        } else {
          throw new Error(response.data.error);
        }
      } catch (apiError) {
        console.error('‚ùå Ëé∑ÂèñÂÆ¢Êà∑Èó®Êà∑ÈìæÊé•Â§±Ë¥•:', apiError);
        await this.lineAdapter.replyMessage(event.replyToken, 
          MessageTemplates.createTextMessage('‚ùå Áî≥„ÅóË®≥„Åî„Åñ„ÅÑ„Åæ„Åõ„Çì„ÄÇ„Çµ„Éñ„Çπ„ÇØ„É™„Éó„Ç∑„Éß„É≥ÁÆ°ÁêÜ„Éö„Éº„Ç∏„Å∏„ÅÆ„Ç¢„ÇØ„Çª„Çπ„Å´ÂïèÈ°å„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ\n\n„Åó„Å∞„Çâ„Åè„Åó„Å¶„Åã„ÇâÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ')
        );
      }
      
      return { success: true };
    } catch (error) {
      console.error('‚ùå Â§ÑÁêÜÂèñÊ∂àËÆ¢ÈòÖËØ∑Ê±ÇÂ§±Ë¥•:', error);
      await this.lineAdapter.replyMessage(event.replyToken, 
        MessageTemplates.createTextMessage('‚ùå Áî≥„ÅóË®≥„Åî„Åñ„ÅÑ„Åæ„Åõ„Çì„ÄÇÂá¶ÁêÜ‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„Åó„Å∞„Çâ„Åè„Åó„Å¶„Åã„ÇâÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ')
      );
      return { success: false, error: error.message };
    }
  }

  async handleConfirmCancelSubscription(event, user) {
    try {
      console.log(`‚úÖ Áî®Êà∑ ${user.id} Á°ÆËÆ§ÂèñÊ∂àËÆ¢ÈòÖ`);
      
      // Ë∞ÉÁî®APIÂèñÊ∂àËÆ¢ÈòÖ
      const axios = require('axios');
      const baseUrl = process.env.VERCEL_URL ? `https://${process.env.VERCEL_URL}` : 'http://localhost:3000';
      
      const response = await axios.post(`${baseUrl}/api/cancel-subscription`, {
        userId: user.id
      });
      
      if (response.data.success) {
        await this.lineAdapter.replyMessage(event.replyToken, 
          MessageTemplates.createTextMessage('‚úÖ „Çµ„Éñ„Çπ„ÇØ„É™„Éó„Ç∑„Éß„É≥„ÇíËß£Á¥Ñ„ÅÑ„Åü„Åó„Åæ„Åó„Åü„ÄÇ\n\n„ÅîÂà©Áî®„ÅÑ„Åü„Å†„Åç„ÄÅ„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åó„Åü„ÄÇ')
        );
      } else {
        throw new Error(response.data.error);
      }
      
      return { success: true };
    } catch (error) {
      console.error('‚ùå Á°ÆËÆ§ÂèñÊ∂àËÆ¢ÈòÖÂ§±Ë¥•:', error);
      await this.lineAdapter.replyMessage(event.replyToken, 
        MessageTemplates.createTextMessage('‚ùå Áî≥„ÅóË®≥„Åî„Åñ„ÅÑ„Åæ„Åõ„Çì„ÄÇËß£Á¥ÑÂá¶ÁêÜ‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„Åó„Å∞„Çâ„Åè„Åó„Å¶„Åã„ÇâÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ')
      );
      return { success: false, error: error.message };
    }
  }

  async handleCancelSubscriptionCancel(event, user) {
    try {
      console.log(`‚ùå Áî®Êà∑ ${user.id} ÂèñÊ∂à‰∫ÜÂèñÊ∂àËÆ¢ÈòÖÊìç‰Ωú`);
      await this.lineAdapter.replyMessage(event.replyToken, 
        MessageTemplates.createTextMessage('‚úÖ Ëß£Á¥Ñ„Çí„Ç≠„É£„É≥„Çª„É´„Åó„Åæ„Åó„Åü„ÄÇ\n\nÂºï„ÅçÁ∂ö„Åç„Çµ„Éº„Éì„Çπ„Çí„ÅîÂà©Áî®„Åè„Å†„Åï„ÅÑ„ÄÇ')
      );
      return { success: true };
    } catch (error) {
      console.error('‚ùå Â§ÑÁêÜÂèñÊ∂àÂèñÊ∂àËÆ¢ÈòÖÂ§±Ë¥•:', error);
      await this.lineAdapter.replyMessage(event.replyToken, 
        MessageTemplates.createTextMessage('‚ùå Áî≥„ÅóË®≥„Åî„Åñ„ÅÑ„Åæ„Åõ„Çì„ÄÇÂá¶ÁêÜ‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ')
      );
      return { success: false, error: error.message };
    }
  }

  async handleNoPhotoAction(event, user) {
    try {
      // Ê™¢Êü•Áî®Êà∂ÊòØÂê¶Êúâ prompt
      if (!user.current_prompt) {
        await this.lineAdapter.replyMessage(event.replyToken, 
          MessageTemplates.createErrorMessage('system_error')
        );
        return { success: false, error: 'No prompt found' };
      }
      
      // Áç≤ÂèñÁî®Êà∂ÈÖçÈ°ç‰ø°ÊÅØ
      const quota = await this.videoService.checkVideoQuota(user.id);
      
      // ‰ΩøÁî® null ‰ΩúÁÇ∫ imageUrlÔºåÈ°ØÁ§∫Á¢∫Ë™çÂç°Áâá
      const confirmationCard = MessageTemplates.createGenerationConfirmCard(null, user.current_prompt, quota);
      await this.lineAdapter.replyMessage(event.replyToken, confirmationCard);
       
      // Â∞á prompt Âíå ÁÑ°ÂúñÁâá ÁãÄÊÖãÊö´Â≠ò
      await this.userService.setUserState(
        user.id,
        'awaiting_confirm',
        JSON.stringify({ prompt: user.current_prompt, imageUrl: null })
      );
      
      return { success: true };
    } catch (error) {
      console.error('‚ùå ËôïÁêÜNo PhotoÂãï‰ΩúÂ§±Êïó:', error);
      await this.lineAdapter.replyMessage(event.replyToken, 
        MessageTemplates.createErrorMessage('system_error')
      );
      return { success: false, error: error.message };
    }
  }

  async handleCheckVideoStatus(event, user) {
    try {
      // 1. Ê£ÄÊü•Áî®Êà∑ÊòØÂê¶ÊúâÊ≠£Âú®ËøõË°åÁöÑËßÜÈ¢ë‰ªªÂä°
      const pendingTasks = await this.videoService.db.getUserPendingTasks(user.line_user_id);
      
      if (pendingTasks.length === 0) {
        // Ê≤°ÊúâÊ≠£Âú®ÁîüÊàêÁöÑËßÜÈ¢ëÔºåÂàáÊç¢Âà∞‰∏ªËèúÂçïÂπ∂ÊèêÁ§∫
        await this.lineAdapter.switchToMainMenu(user.line_user_id);
        await this.lineAdapter.replyMessage(event.replyToken, {
          type: 'text',
          text: 'üì± ÁèæÂú®ÁîüÊàê‰∏≠„ÅÆÂãïÁîª„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ\n\n„É°„Ç§„É≥„É°„Éã„É•„Éº„Å´Êàª„Çä„Åæ„Åó„Åü„ÄÇ'
        });
        return { success: true, message: 'No pending tasks, switched to main menu' };
      }

      // 2. Ëé∑Âèñ‰ªªÂä°‰ø°ÊÅØ
      const task = pendingTasks[0]; // ÂÅáËÆæÂè™Êúâ‰∏Ä‰∏™‰ªªÂä°
      const VideoGenerator = require('../services/video-generator');
      const videoGenerator = new VideoGenerator(this.videoService.db);

      // 3. ÁªßÁª≠ËΩÆËØ¢Áõ¥Âà∞ÂÆåÊàêÔºàÊúÄÂ§ö5ÂàÜÈíüÔºâ
      const maxPollingTime = 5 * 60 * 1000; // 5ÂàÜÈíü
      const pollInterval = 10000; // 10Áßí
      const startTime = Date.now();
      
      let finalResult = null;
      let pollErrorCount = 0;
      const maxPollErrors = 5; // ÊúÄÂ§öÂÖÅËÆ∏5Ê¨°ËΩÆËØ¢ÈîôËØØ
      
      while (Date.now() - startTime < maxPollingTime) {
        try {
          const status = await videoGenerator.checkTaskStatus(task.task_id);
          
          if (status.state === 'success') {
            // ÁîüÊàêÊàêÂäü
            await this.videoService.updateVideoStatus(task.id, 'completed', status.videoUrl);
            finalResult = {
              success: true,
              videoUrl: status.videoUrl,
              thumbnailUrl: status.thumbnailUrl
            };
            break;
          } else if (status.state === 'failed' || status.state === 'error') {
            // ÁîüÊàêÂ§±Ë¥•ÔºåÊÅ¢Â§çÈÖçÈ¢ù
            await this.videoService.handleVideoFailure(task.id, status.message, true);
            finalResult = {
              success: false,
              error: status.message || 'ÂãïÁîªÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü'
            };
            break;
          }
          
          // ÈáçÁΩÆÈîôËØØËÆ°Êï∞Âô®ÔºàÊàêÂäüËΩÆËØ¢Ôºâ
          pollErrorCount = 0;
          // ÁªßÁª≠ËΩÆËØ¢ÂâçÁ≠âÂæÖ
          await new Promise(resolve => setTimeout(resolve, pollInterval));
        } catch (pollError) {
          console.error('‚ùå ËΩÆËØ¢ÈîôËØØ:', pollError);
          pollErrorCount++;
          
          // Â¶ÇÊûúËΩÆËØ¢ÈîôËØØÊ¨°Êï∞ËøáÂ§öÔºåËÆ§‰∏∫‰ªªÂä°Â§±Ë¥•Âπ∂ÊÅ¢Â§çÈÖçÈ¢ù
          if (pollErrorCount >= maxPollErrors) {
            console.error('‚ùå ËΩÆËØ¢ÈîôËØØÊ¨°Êï∞ËøáÂ§öÔºåÊÅ¢Â§çÈÖçÈ¢ù');
            await this.videoService.handleVideoFailure(task.id, 'ËΩÆËØ¢ÊúçÂä°ÂºÇÂ∏∏', true);
            finalResult = {
              success: false,
              error: 'ÂãïÁîªÁîüÊàê„Çµ„Éº„Éì„Çπ„Å´Êé•Á∂ö„Åß„Åç„Åæ„Åõ„Çì'
            };
            break;
          }
          
          // ÁªßÁª≠ËΩÆËØ¢Ôºå‰∏çÁ´ãÂç≥Â§±Ë¥•
          await new Promise(resolve => setTimeout(resolve, pollInterval));
        }
      }

      // 4. Â§ÑÁêÜÁªìÊûúÂπ∂Áî®replyMessageÂõûÂ§ç
      if (finalResult) {
        if (finalResult.success) {
          // ÊàêÂäüÔºöÂèëÈÄÅËßÜÈ¢ë
          const completedMessages = MessageTemplates.createVideoStatusMessages('completed', {
            videoUrl: finalResult.videoUrl,
            thumbnailUrl: finalResult.thumbnailUrl
          });
          await this.lineAdapter.replyMessage(event.replyToken, completedMessages);
        } else {
          // Â§±Ë¥•ÔºöÂèëÈÄÅÈîôËØØ‰ø°ÊÅØ
          await this.lineAdapter.replyMessage(event.replyToken, {
            type: 'text',
            text: `‚ùå ÂãïÁîªÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ\n\nË©≥Á¥∞: ${finalResult.error}\n\n‚úÖ „ÅîÂÆâÂøÉ„Åè„Å†„Åï„ÅÑ„ÄÇÂà©Áî®Êû†„ÅØÊ∂àË≤ª„Åï„Çå„Å¶„Åä„Çä„Åæ„Åõ„Çì„ÄÇ\n\nüîÑ „Åó„Å∞„Çâ„Åè„Åó„Å¶„Åã„ÇâÂÜçÂ∫¶„ÅäË©¶„Åó„ÅÑ„Åü„Å†„Åè„Åã„ÄÅÂà•„ÅÆÂÜôÁúü„Åß„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ`
          });
        }
        // ÂàáÊç¢Âõû‰∏ªËèúÂçï
        await this.lineAdapter.switchToMainMenu(user.line_user_id);
      } else {
        // ÂÜçÊ¨°Ë∂ÖÊó∂ÔºöÂëäÁü•Áî®Êà∑Á®çÂêéÂÜçËØï
        await this.lineAdapter.replyMessage(event.replyToken, {
          type: 'text',
          text: 'üé¨ ÂãïÁîªÁîüÊàê‰∏≠„Åß„Åô...\n\n‚è±Ô∏è ÁîüÊàê„Å´„Åï„Çâ„Å´ÊôÇÈñì„Åå„Åã„Åã„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇ\n\nüîÑ „Åó„Å∞„Çâ„Åè„ÅäÂæÖ„Å°„ÅÑ„Åü„Å†„ÅÑ„Å¶„Åã„Çâ„ÄÅÂÜçÂ∫¶„É°„Éã„É•„Éº„Çí„Çø„ÉÉ„Éó„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'
        });
        // ‰øùÊåÅprocessing menuÁä∂ÊÄÅ
      }

      return { success: true };
    } catch (error) {
      console.error('‚ùå Â§ÑÁêÜÁä∂ÊÄÅÁ°ÆËÆ§Â§±Ë¥•:', error);
      try {
        // üö® ÈáçË¶ÅÔºöÂ¶ÇÊûúÊúâpending‰ªªÂä°ÔºåÁ≥ªÁªüÈîôËØØÊó∂‰πüË¶ÅÊÅ¢Â§çÈÖçÈ¢ù
        const pendingTasks = await this.videoService.db.getUserPendingTasks(user.line_user_id);
        if (pendingTasks.length > 0) {
          const task = pendingTasks[0];
          console.log('üîÑ Áä∂ÊÄÅÁ°ÆËÆ§Á≥ªÁªüÈîôËØØÔºåÊÅ¢Â§çÁî®Êà∑ÈÖçÈ¢ù:', task.id);
          await this.videoService.handleVideoFailure(task.id, 'Áä∂ÊÄÅÁ°ÆËÆ§Á≥ªÁªüÈîôËØØ', true);
        }
        
        await this.lineAdapter.replyMessage(event.replyToken, {
          type: 'text',
          text: '‚ùå ÈÄ≤ÊçóÁ¢∫Ë™ç‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ\n\n‚úÖ Âà©Áî®Êû†„ÅØÊ∂àË≤ª„Åï„Çå„Å¶„Åä„Çä„Åæ„Åõ„Çì„ÄÇ\n\nüîÑ „Åó„Å∞„Çâ„Åè„Åó„Å¶„Åã„ÇâÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ'
        });
        await this.lineAdapter.switchToMainMenu(user.line_user_id);
      } catch (replyError) {
        console.error('‚ùå ÂèëÈÄÅÈîôËØØÂõûÂ§çÂ§±Ë¥•:', replyError);
      }
      return { success: false, error: error.message };
    }
  }

  async handleSwitchToMainMenu(event, user) {
    try {
      await this.lineAdapter.switchToMainMenu(user.line_user_id);
      return { success: true };
    } catch (error) {
      console.error('‚ùå ÂàáÊç¢Âà∞‰∏ªËèúÂçïÂ§±Ë¥•:', error);
      await this.lineAdapter.replyMessage(event.replyToken, 
        MessageTemplates.createErrorMessage('system_error')
      );
      return { success: false, error: error.message };
    }
  }
}

module.exports = EventHandler; 