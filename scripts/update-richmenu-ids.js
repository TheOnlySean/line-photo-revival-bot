const { Client } = require('@line/bot-sdk');
const fs = require('fs');
const path = require('path');
const lineConfig = require('../config/line-config');

// åˆ›å»ºLINEå®¢æˆ·ç«¯
const client = new Client({
  channelSecret: lineConfig.channelSecret,
  channelAccessToken: lineConfig.channelAccessToken
});

async function updateRichMenuIds() {
  console.log('ğŸ” è·å–å½“å‰Rich Menuä¿¡æ¯...');
  
  try {
    // è·å–æ‰€æœ‰Rich Menu
    const richMenuList = await client.getRichMenuList();
    console.log(`ğŸ“‹ æ‰¾åˆ° ${richMenuList.length} ä¸ªRich Menu`);
    
    let mainMenuId = null;
    let processingMenuId = null;
    
    // è¯†åˆ«å„ä¸ªèœå•
    for (const menu of richMenuList) {
      console.log(`ğŸ“‹ èœå•: ${menu.name} (${menu.richMenuId})`);
      
      if (menu.name.includes('Main') || menu.name.includes('ä¸»è¦') || menu.name.includes('ãƒ¡ã‚¤ãƒ³')) {
        mainMenuId = menu.richMenuId;
        console.log('ğŸ¯ ä¸»èœå•ID:', mainMenuId);
      } else if (menu.name.includes('Processing') || menu.name.includes('ç”Ÿæˆä¸­') || menu.name.includes('å‡¦ç†ä¸­')) {
        processingMenuId = menu.richMenuId;
        console.log('ğŸ¯ å¤„ç†ä¸­èœå•ID:', processingMenuId);
      }
    }
    
    if (!mainMenuId || !processingMenuId) {
      console.error('âŒ æ— æ³•æ‰¾åˆ°å®Œæ•´çš„Rich Menu ID');
      return;
    }
    
    // æ›´æ–°services/line-bot.jsä¸­çš„Rich Menu IDè®¾ç½®
    console.log('\nğŸ“ æ›´æ–°ä»£ç ä¸­çš„Rich Menu ID...');
    
    const lineBotPath = path.join(__dirname, '../services/line-bot.js');
    let lineBotContent = fs.readFileSync(lineBotPath, 'utf8');
    
    // æ›´æ–°æ„é€ å‡½æ•°æˆ–åˆå§‹åŒ–éƒ¨åˆ†
    // åœ¨ç±»çš„æ„é€ å‡½æ•°ä¸­æ·»åŠ å›ºå®šçš„Rich Menu ID
    const constructorPattern = /constructor\(client, db\) {[\s\S]*?}/;
    const constructorMatch = lineBotContent.match(constructorPattern);
    
    if (constructorMatch) {
      const newConstructor = `constructor(client, db) {
    this.client = client;
    this.db = db;
    this.channelId = lineConfig.channelId;
    
    // å›ºå®šçš„Rich Menu ID (ç”±è„šæœ¬è‡ªåŠ¨æ›´æ–°)
    this.mainRichMenuId = '${mainMenuId}';
    this.processingRichMenuId = '${processingMenuId}';
  }`;
      
      lineBotContent = lineBotContent.replace(constructorMatch[0], newConstructor);
      console.log('âœ… å·²æ›´æ–°æ„é€ å‡½æ•°ä¸­çš„Rich Menu ID');
    }
    
    // å†™å›æ–‡ä»¶
    fs.writeFileSync(lineBotPath, lineBotContent, 'utf8');
    console.log('âœ… line-bot.jsæ›´æ–°å®Œæˆ');
    
    // åˆ›å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œå­˜å‚¨Rich Menu ID
    const configPath = path.join(__dirname, '../config/richmenu-ids.json');
    const richMenuConfig = {
      mainRichMenuId: mainMenuId,
      processingRichMenuId: processingMenuId,
      updatedAt: new Date().toISOString(),
      note: 'This file is automatically generated by update-richmenu-ids.js'
    };
    
    fs.writeFileSync(configPath, JSON.stringify(richMenuConfig, null, 2), 'utf8');
    console.log('âœ… Rich Menué…ç½®æ–‡ä»¶å·²åˆ›å»º:', configPath);
    
    console.log('\nğŸ‰ Rich Menu IDæ›´æ–°å®Œæˆï¼');
    console.log('');
    console.log('ğŸ“‹ æ›´æ–°ç»“æœ:');
    console.log(`ä¸»èœå•ID: ${mainMenuId}`);
    console.log(`å¤„ç†ä¸­èœå•ID: ${processingMenuId}`);
    console.log('');
    console.log('âœ¨ ç°åœ¨ä»£ç å°†ä½¿ç”¨æ­£ç¡®çš„Rich Menu IDè¿›è¡Œåˆ‡æ¢ï¼');
    
    return {
      mainMenuId,
      processingMenuId
    };
    
  } catch (error) {
    console.error('âŒ æ›´æ–°Rich Menu IDå¤±è´¥:', error.message);
    
    if (error.response) {
      console.error('ğŸ“Š APIé”™è¯¯çŠ¶æ€:', error.response.status);
      console.error('ğŸ“‹ APIé”™è¯¯è¯¦æƒ…:', error.response.data);
    }
  }
}

// æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
function showHelp() {
  console.log(`
ğŸ”„ Rich Menu IDæ›´æ–°å·¥å…·

åŠŸèƒ½ï¼š
- è·å–å½“å‰æ‰€æœ‰Rich Menuçš„ID
- æ›´æ–°ä»£ç ä¸­çš„Rich Menu IDå¼•ç”¨
- åˆ›å»ºRich Menué…ç½®æ–‡ä»¶
- ç¡®ä¿ä»£ç ä½¿ç”¨æ­£ç¡®çš„èœå•ID

ä½¿ç”¨æ–¹æ³•ï¼š
  node scripts/update-richmenu-ids.js

æ›´æ–°å†…å®¹ï¼š
- services/line-bot.js: æ„é€ å‡½æ•°ä¸­çš„èœå•ID
- config/richmenu-ids.json: èœå•IDé…ç½®æ–‡ä»¶

æ³¨æ„äº‹é¡¹ï¼š
- éœ€è¦å…ˆåˆ›å»ºRich Menu
- ä¼šè‡ªåŠ¨è¯†åˆ«Mainå’ŒProcessingèœå•
- å¤‡ä»½é‡è¦æ–‡ä»¶å†è¿è¡Œ
`);
}

if (require.main === module) {
  if (process.argv.includes('--help') || process.argv.includes('-h')) {
    showHelp();
  } else {
    updateRichMenuIds()
      .then(result => {
        if (result) {
          console.log('ğŸ¯ Rich Menu IDæ›´æ–°æˆåŠŸï¼');
        }
      })
      .catch(error => {
        console.error('ğŸ’¥ æ›´æ–°è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯');
        process.exit(1);
      });
  }
}

module.exports = updateRichMenuIds; 